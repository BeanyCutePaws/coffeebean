// assets/js/admin-order-view.js
document.addEventListener("DOMContentLoaded", () => {
  const wrap = document.getElementById("js-order-view-wrapper");
  if (!wrap || !window.ADMIN_ORDER_VIEW) return;

  const ajaxUrl = window.ADMIN_ORDER_VIEW.ajaxUrl;
  const nextUrl = window.ADMIN_ORDER_VIEW.nextStatusUrl;

  function withAjax(url) {
    const u = new URL(url, window.location.origin);
    u.searchParams.set("ajax", "1");
    return u.toString();
  }

  async function refreshWrapper() {
    try {
      const res = await fetch(withAjax(ajaxUrl), { cache: "no-store" });
      const html = await res.text();
      wrap.innerHTML = html;
    } catch (_) {}
  }

  // Next status (delegated)
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".js-next-status");
    if (!btn) return;

    const orderId = btn.dataset.orderId;
    if (!orderId) return;

    btn.disabled = true;
    const old = btn.innerHTML;
    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin me-2"></i>Updating...`;

    try {
      const body = new URLSearchParams({ order_id: orderId });
      const res = await fetch(nextUrl, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });
      const data = await res.json();

      if (!data.success) {
        btn.innerHTML = old;
        btn.disabled = false;
        return;
      }

      await refreshWrapper();
    } catch (_) {
      btn.innerHTML = old;
      btn.disabled = false;
    }
  });

  // Auto refresh every 5s
  setInterval(refreshWrapper, 5000);
});
